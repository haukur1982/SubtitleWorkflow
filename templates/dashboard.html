<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omega Compressor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-app: #0f0f0f;
            --bg-panel: #1a1a1a;
            --border: #333333;
            --text-main: #ffffff;
            --text-dim: #a3a3a3;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
        }

        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
        }

        .panel {
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            min-height: 0;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            grid-template-rows: 1fr;
            height: 100vh;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .selected-row {
            background-color: rgba(59, 130, 246, 0.15);
            border-left: 2px solid var(--accent);
        }

        select,
        button {
            transition: all 0.2s ease;
        }

        #inspector-content {
            min-height: 0;
        }
    </style>
</head>

<body>

    <div class="grid-layout">
        <!-- LEFT: INPUT & DROP ZONE -->
        <div class="panel flex flex-col">
            <div class="p-5 border-b border-[#333]">
                <h2 class="text-[10px] font-bold text-[#666] uppercase tracking-[0.2em]">Input Source</h2>
            </div>

            <!-- Minimalist Drop Zone -->
            <div id="drop-zone"
                class="m-5 flex-1 border border-dashed border-[#444] rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-white hover:bg-[#222] transition-all group relative overflow-hidden">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity">
                </div>

                <!-- Modern Icon -->
                <svg class="w-12 h-12 text-[#444] group-hover:text-white transition-colors mb-4" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                    </path>
                </svg>

                <p class="text-sm font-medium text-[#888] group-hover:text-white transition-colors">Drop Media</p>
                <input type="file" id="file-input" class="hidden" multiple>
            </div>

            <div class="p-5 border-t border-[#333]">
                <h3 class="text-[10px] font-bold text-[#666] mb-4 uppercase tracking-[0.2em]">Watch Folders</h3>
                <ul class="space-y-3">
                    <li class="flex items-center gap-3 text-[#aaa] hover:text-white transition-colors cursor-default">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)]">
                        </div>
                        <span class="font-medium">Auto Pilot</span>
                    </li>
                    <li class="flex items-center gap-3 text-[#aaa] hover:text-white transition-colors cursor-default">
                        <div class="w-1.5 h-1.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.4)]"></div>
                        <span class="font-medium">Human Review</span>
                    </li>
                </ul>
            </div>

            <div class="p-5 border-t border-[#333]">
                <h3 class="text-[10px] font-bold text-[#666] mb-4 uppercase tracking-[0.2em]">System</h3>

                <div class="space-y-2 text-xs">
                    <div class="flex items-center justify-between">
                        <span class="text-[#888]">Manager</span>
                        <span id="sys-manager" class="font-mono text-[#666]">--</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[#888]">SSD</span>
                        <span id="sys-ssd" class="font-mono text-[#666]">--</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-[#888]">Free</span>
                        <span id="sys-disk" class="font-mono text-[#666]">--</span>
                    </div>
                </div>

                <div class="mt-4">
                    <label
                        class="block text-[10px] font-bold text-[#666] uppercase tracking-wider mb-2">Admin Token</label>
                    <input id="admin-token-input" type="password" placeholder="(optional, for remote access)"
                        class="w-full bg-[#222] border border-[#333] rounded-lg px-3 py-2 text-xs text-white focus:border-[#555] focus:ring-0 outline-none" />
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button onclick="saveAdminToken()"
                            class="bg-[#222] hover:bg-[#2a2a2a] text-[#aaa] hover:text-white py-2 rounded-lg text-xs border border-[#333] transition-colors">
                            Save
                        </button>
                        <button onclick="clearAdminToken()"
                            class="bg-[#222] hover:bg-[#2a2a2a] text-[#aaa] hover:text-white py-2 rounded-lg text-xs border border-[#333] transition-colors">
                            Clear
                        </button>
                    </div>
                </div>

                <button onclick="restartManager()" id="btn-restart-manager"
                    class="w-full mt-3 bg-[#222] hover:bg-[#2a2a2a] text-[#aaa] hover:text-white py-2.5 rounded-lg text-xs border border-[#333] transition-colors">
                    Restart Manager
                </button>
            </div>
        </div>

        <!-- CENTER: BATCH LIST -->
        <div class="panel flex flex-col relative border-r-0">
            <!-- Tabs Header -->
            <div class="flex border-b border-[#333] bg-[#1a1a1a]">
                <button onclick="switchTab('active')" id="tab-active"
                    class="flex-1 py-3 text-[11px] font-bold uppercase tracking-wider text-white border-b-2 border-blue-500 bg-[#222]">Active</button>
                <button onclick="switchTab('completed')" id="tab-completed"
                    class="flex-1 py-3 text-[11px] font-bold uppercase tracking-wider text-[#666] hover:text-[#aaa] border-b-2 border-transparent">Completed</button>
            </div>

            <div class="p-3 border-b border-[#333] flex justify-between items-center bg-[#1a1a1a]">
                <h2 class="text-[10px] font-bold text-[#666] uppercase tracking-[0.2em]" id="list-title">Queue</h2>
                <div class="flex gap-3 items-center">
                    <span class="text-[9px] text-[#444] font-mono">v2.1 (Live)</span>
                    <button onclick="fetchJobs()"
                        class="text-[10px] font-bold text-[#666] hover:text-white uppercase tracking-wider transition-colors">Refresh</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto bg-[#111]">
                <table class="w-full text-left">
                    <thead
                        class="bg-[#161616] text-[#666] sticky top-0 text-[11px] uppercase tracking-wider font-semibold border-b border-[#222]">
                        <tr>
                            <th class="p-4 w-12"></th>
                            <th class="p-4">Name</th>
                            <th class="p-4">Status</th>
                            <th class="p-4">Elapsed</th>
                            <th class="p-4 w-32">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="job-list" class="divide-y divide-[#222]">
                        <!-- Jobs injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Mini Log -->
            <div class="h-32 border-t border-[#333] bg-[#0f0f0f] p-3 overflow-y-auto font-mono text-[10px] text-[#555]"
                id="mini-log">
                <div class="text-[#333]">System Ready...</div>
            </div>
        </div>

        <!-- RIGHT: INSPECTOR -->
        <div class="panel flex flex-col bg-[#1a1a1a] border-l border-[#333]">
            <div class="p-5 border-b border-[#333]">
                <h2 class="text-[10px] font-bold text-[#666] uppercase tracking-[0.2em]">Inspector</h2>
            </div>

            <div id="inspector-content" class="p-6 flex-1 overflow-y-auto hidden">
                <!-- Header -->
                <div class="mb-8">
                    <h1 class="text-xl font-medium text-white mb-2 truncate tracking-tight" id="insp-title">Filename
                    </h1>
                    <p class="text-[11px] text-[#666] font-mono mb-4" id="insp-id">ID: ...</p>

                    <!-- Live Status Badge -->
                    <div class="flex items-center gap-3">
                        <div
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-[#222] border border-[#333]">
                            <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse" id="insp-status-dot"></div>
                            <span class="text-xs font-medium text-white" id="insp-status-text">Processing...</span>
                        </div>
                        <span id="save-indicator"
                            class="text-xs font-medium text-emerald-500 opacity-0 transition-opacity duration-500">‚úì
                            Saved</span>
                    </div>
                </div>

                <!-- Process Stepper -->
                <div class="mb-8">
                    <h3 class="text-[10px] font-bold text-[#666] uppercase tracking-wider mb-4">Process Flow</h3>
                    <div class="relative flex flex-col gap-4 pl-2 border-l border-[#333]">
                        <!-- Step 1: Ingest -->
                        <div class="flex items-center gap-3 relative">
                            <div class="absolute -left-[13px] w-6 h-6 rounded-full bg-[#1a1a1a] border border-[#333] flex items-center justify-center z-10"
                                id="step-ingest-dot">
                                <div class="w-1.5 h-1.5 rounded-full bg-[#444]" id="step-ingest-inner"></div>
                            </div>
                            <span class="text-xs text-[#666] ml-6" id="step-ingest-text">Ingest & Transcribe</span>
                        </div>
                        <!-- Step 2: Translate -->
                        <div class="flex items-center gap-3 relative">
                            <div class="absolute -left-[13px] w-6 h-6 rounded-full bg-[#1a1a1a] border border-[#333] flex items-center justify-center z-10"
                                id="step-translate-dot">
                                <div class="w-1.5 h-1.5 rounded-full bg-[#444]" id="step-translate-inner"></div>
                            </div>
                            <span class="text-xs text-[#666] ml-6" id="step-translate-text">Translate & Review</span>
                        </div>
                        <!-- Step 3: Burn -->
                        <div class="flex items-center gap-3 relative">
                            <div class="absolute -left-[13px] w-6 h-6 rounded-full bg-[#1a1a1a] border border-[#333] flex items-center justify-center z-10"
                                id="step-burn-dot">
                                <div class="w-1.5 h-1.5 rounded-full bg-[#444]" id="step-burn-inner"></div>
                            </div>
                            <span class="text-xs text-[#666] ml-6" id="step-burn-text">Finalize & Burn</span>
                        </div>
                    </div>
                </div>

                <!-- Monitoring -->
                <div id="monitoring-section" class="mb-8 bg-[#1a1a1a] border border-[#333] rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] font-bold text-[#666] uppercase tracking-wider">Monitoring</span>
                        <span id="monitor-total" class="text-[10px] text-[#666] font-mono">--</span>
                    </div>
                    <div class="mb-3">
                        <div class="text-[10px] font-bold text-[#555] uppercase tracking-wider mb-2">Pipeline Timeline</div>
                        <div id="monitor-stage-list" class="space-y-1 text-xs text-[#aaa] font-mono"></div>
                    </div>
                    <div class="mb-3">
                        <div class="text-[10px] font-bold text-[#555] uppercase tracking-wider mb-2">Cloud Timeline</div>
                        <div id="monitor-cloud-summary" class="text-[10px] text-[#666] mb-2">--</div>
                        <div id="monitor-cloud-list" class="space-y-1 text-xs text-[#aaa] font-mono"></div>
                    </div>
                    <div>
                        <div class="text-[10px] font-bold text-[#555] uppercase tracking-wider mb-2">Recent Status</div>
                        <div id="monitor-status-list" class="space-y-1 text-xs text-[#888] font-mono"></div>
                    </div>
                </div>

                <!-- Settings Form -->
                <div class="space-y-6">
                    <div class="group">
                        <label
                            class="block text-[10px] font-bold text-[#666] uppercase tracking-wider mb-2 group-hover:text-[#888] transition-colors">Target
                            Language</label>
                        <div class="relative">
                            <select id="insp-lang" onchange="updateJobSetting('target_language', this.value)"
                                class="w-full bg-[#222] border border-[#333] rounded-lg px-3 py-2.5 text-sm text-white focus:border-[#555] focus:ring-0 outline-none appearance-none hover:bg-[#262626] transition-colors">
                                <option value="is">Icelandic</option>
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="pt">Portuguese</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="it">Italian</option>
                            </select>
                            <div class="absolute right-3 top-3 pointer-events-none text-[#666]">‚ñº</div>
                        </div>
                    </div>

                    <div class="group">
                        <label
                            class="block text-[10px] font-bold text-[#666] uppercase tracking-wider mb-2 group-hover:text-[#888] transition-colors">Program
                            Profile</label>
                        <div class="relative">
                            <select id="insp-profile" onchange="updateJobSetting('program_profile', this.value)"
                                class="w-full bg-[#222] border border-[#333] rounded-lg px-3 py-2.5 text-sm text-white focus:border-[#555] focus:ring-0 outline-none appearance-none hover:bg-[#262626] transition-colors">
                                <option value="standard">Standard (Omega TV)</option>
                                <option value="in_touch">In Touch</option>
                                <option value="benny_hinn">Benny Hinn</option>
                            </select>
                            <div class="absolute right-3 top-3 pointer-events-none text-[#666]">‚ñº</div>
                        </div>
                    </div>

                    <div class="group">
                        <label
                            class="block text-[10px] font-bold text-[#666] uppercase tracking-wider mb-2 group-hover:text-[#888] transition-colors">Visual
                            Style</label>
                        <div class="relative">
                            <select id="insp-style" onchange="updateJobSetting('subtitle_style', this.value)"
                                class="w-full bg-[#222] border border-[#333] rounded-lg px-3 py-2.5 text-sm text-white focus:border-[#555] focus:ring-0 outline-none appearance-none hover:bg-[#262626] transition-colors">
                                <option value="Classic">Classic Box</option>
                                <option value="Modern">Modern Clean</option>
                                <option value="Apple">Apple Pro</option>
                            </select>
                            <div class="absolute right-3 top-3 pointer-events-none text-[#666]">‚ñº</div>
                        </div>
                    </div>

                    <div class="group">
                        <label
                            class="block text-[10px] font-bold text-[#666] uppercase tracking-wider mb-2 group-hover:text-[#888] transition-colors">Workflow
                            Mode</label>
                        <!-- Mode Toggle -->
                        <div class="flex bg-[#222] p-1 rounded-lg mb-6">
                            <button id="btn-mode-auto" onclick="setMode('AUTO')"
                                class="flex-1 py-2 text-[11px] font-medium rounded-md transition-all text-[#666] hover:text-white hover:bg-[#333]">AUTO
                                PILOT</button>
                            <button id="btn-mode-review" onclick="setMode('REVIEW')"
                                class="flex-1 py-2 text-[11px] font-medium rounded-md transition-all text-[#666] hover:text-white hover:bg-[#333]">MANUAL
                                REVIEW</button>
                        </div>

                        <!-- Surgical Tool Trigger -->
                        <button onclick="openSurgical()"
                            class="w-full mb-6 flex items-center justify-center gap-2 bg-[#222] hover:bg-[#333] border border-[#333] hover:border-[#444] text-[#888] hover:text-white py-2 rounded transition-all group">
                            <span class="text-lg">ü©∫</span>
                            <span class="text-xs font-bold uppercase tracking-wider">Open Live Editor</span>
                        </button>

                        <!-- Quality Report -->
                        <div id="quality-report" class="hidden mb-6 bg-[#1a1a1a] border border-[#333] rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[10px] font-bold text-[#666] uppercase tracking-wider">Quality
                                    Report</span>
                                <div id="qr-rating"
                                    class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold">--
                                </div>
                            </div>
                            <div id="qr-tier" class="text-sm font-medium text-white mb-2">--</div>
                            <p id="qr-summary" class="text-xs text-[#888] leading-relaxed mb-3">--</p>

                            <div id="qr-issues-container" class="hidden mb-3">
                                <span
                                    class="text-[10px] font-bold text-[#666] uppercase tracking-wider block mb-1">Major
                                    Issues</span>
                                <ul id="qr-issues" class="list-disc list-inside text-xs text-red-400"></ul>
                            </div>

                            <div id="qr-suggestions-container" class="hidden">
                                <span
                                    class="text-[10px] font-bold text-[#666] uppercase tracking-wider block mb-1">Suggestions</span>
                                <p id="qr-suggestions" class="text-xs text-[#888] italic"></p>
                            </div>
                        </div>

                        <!-- Broadcast QA -->
                        <div id="broadcast-qa" class="hidden mb-6 bg-[#1a1a1a] border border-[#333] rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[10px] font-bold text-[#666] uppercase tracking-wider">Broadcast
                                    QA</span>
                                <div id="qa-caps-badge"
                                    class="px-2 py-1 rounded bg-red-500/20 text-red-300 text-xs font-bold">--</div>
                            </div>
                            <p id="qa-caps-text" class="text-xs text-[#888] leading-relaxed mb-3">--</p>

                            <div id="qa-caps-samples-container" class="hidden">
                                <span
                                    class="text-[10px] font-bold text-[#666] uppercase tracking-wider block mb-1">Examples</span>
                                <ul id="qa-caps-samples" class="list-disc list-inside text-xs text-[#aaa]"></ul>
                            </div>
                        </div>

                        <!-- Subtitle QA -->
                        <div id="subtitle-qa" class="hidden mb-6 bg-[#1a1a1a] border border-[#333] rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[10px] font-bold text-[#666] uppercase tracking-wider">Subtitle
                                    QA</span>
                                <div id="qa-srt-badge"
                                    class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-300 text-xs font-bold">--
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs text-[#888] mb-2">
                                <div>High CPS (&gt;17): <span id="qa-srt-cps17">0</span></div>
                                <div>Very High CPS (&gt;20): <span id="qa-srt-cps20">0</span></div>
                                <div>Short (&lt;1.0s): <span id="qa-srt-short">0</span></div>
                                <div>Long (&gt;7.0s): <span id="qa-srt-long">0</span></div>
                                <div>Long Lines (&gt;42): <span id="qa-srt-longlines">0</span></div>
                                <div>Dangling Endings: <span id="qa-srt-dangling">0</span></div>
                            </div>
                            <p id="qa-srt-note" class="text-[10px] text-[#666]">--</p>
                        </div>

                        <!-- Output -->
                        <div id="output-section" class="hidden mb-6 bg-[#1a1a1a] border border-[#333] rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[10px] font-bold text-[#666] uppercase tracking-wider">Output</span>
                                <a id="btn-download-output" href="#"
                                    class="text-xs font-bold text-blue-400 hover:text-blue-300 transition-colors">Download</a>
                            </div>
                            <p id="output-path" class="text-xs text-[#888] font-mono break-all">--</p>
                        </div>

                        <!-- Last Error / Halt -->
                        <div id="error-box" class="hidden mb-6 bg-red-900/10 border border-red-900/30 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-[10px] font-bold text-red-300 uppercase tracking-wider">Last
                                    Error</span>
                                <span id="halt-badge"
                                    class="hidden px-2 py-1 rounded bg-red-500/20 text-red-300 text-[10px] font-bold uppercase tracking-wider">Halted</span>
                            </div>
                            <p id="error-text" class="text-xs text-[#aaa] font-mono break-words">--</p>
                        </div>

                        <hr class="border-[#333] my-8">

                        <!-- Actions -->
                        <div class="space-y-3">
                            <button id="btn-approve" onclick="approveBurn()"
                                class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-3 rounded-lg shadow-lg shadow-emerald-900/20 transition-all hidden">
                                Approve Burn
                            </button>

                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="resetReview()"
                                    class="w-full bg-[#222] hover:bg-[#2a2a2a] text-[#aaa] hover:text-white py-2.5 rounded-lg text-xs border border-[#333] transition-colors">
                                    Retry Finalize
                                </button>

                                <button onclick="forceBurn()"
                                    class="w-full bg-[#222] hover:bg-red-900/20 text-[#aaa] hover:text-red-400 py-2.5 rounded-lg text-xs border border-[#333] hover:border-red-900/50 transition-colors">
                                    Force Burn
                                </button>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="retryTranslate()"
                                    class="w-full bg-[#222] hover:bg-[#2a2a2a] text-[#aaa] hover:text-white py-2.5 rounded-lg text-xs border border-[#333] transition-colors">
                                    Retry Translate
                                </button>
                                <button onclick="retryReview()"
                                    class="w-full bg-[#222] hover:bg-[#2a2a2a] text-[#aaa] hover:text-white py-2.5 rounded-lg text-xs border border-[#333] transition-colors">
                                    Retry Review
                                </button>
                            </div>

                            <button id="btn-unhalt" onclick="unhaltJob()"
                                class="w-full bg-red-900/10 hover:bg-red-900/30 text-red-500/70 hover:text-red-400 py-2.5 rounded-lg text-xs border border-red-900/20 hover:border-red-900/50 transition-colors hidden">
                                Unhalt Job
                            </button>

                            <button onclick="deleteJob()"
                                class="w-full bg-red-900/10 hover:bg-red-900/30 text-red-500/70 hover:text-red-400 py-2.5 rounded-lg text-xs border border-red-900/20 hover:border-red-900/50 transition-colors mt-2">
                                Delete Job
                            </button>
                        </div>

                        <div class="mt-8 p-4 bg-[#222] border border-[#333] rounded-lg flex items-center gap-3 hidden"
                            id="lock-msg">
                            <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                            <span class="text-xs text-[#888]">Settings locked during processing</span>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="inspector-empty" class="flex-1 flex flex-col items-center justify-center text-[#444]">
                        <div class="text-4xl mb-4 opacity-20">‚ö°Ô∏è</div>
                        <p class="text-xs font-medium uppercase tracking-wider">No Job Selected</p>
                    </div>
                </div>
            </div>

            <script>
                // --- GLOBALS ---
                let jobsData = [];
                let selectedStem = null;
                let currentTab = 'active'; // 'active' or 'completed'
                const ADMIN_TOKEN_STORAGE_KEY = 'omega_admin_token';

                function getAdminToken() {
                    try {
                        return localStorage.getItem(ADMIN_TOKEN_STORAGE_KEY) || '';
                    } catch (e) {
                        return '';
                    }
                }

                function setAdminToken(token) {
                    try {
                        if (token) localStorage.setItem(ADMIN_TOKEN_STORAGE_KEY, token);
                        else localStorage.removeItem(ADMIN_TOKEN_STORAGE_KEY);
                    } catch (e) {
                        // ignore
                    }
                }

                function adminHeaders() {
                    const token = getAdminToken();
                    return token ? { 'X-Omega-Admin-Token': token } : {};
                }

                async function postJson(url, payload) {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...adminHeaders() },
                        body: JSON.stringify(payload)
                    });
                    return await res.json();
                }

                function showSaved() {
                    const el = document.getElementById('save-indicator');
                    if (!el) return;
                    el.classList.remove('opacity-0');
                    el.classList.add('opacity-100');
                    setTimeout(() => {
                        el.classList.add('opacity-0');
                        el.classList.remove('opacity-100');
                    }, 1200);
                }

                // --- INIT ---
                document.addEventListener('DOMContentLoaded', () => {
                    fetchJobs();
                    setInterval(fetchJobs, 2000);

                    // Admin token (optional)
                    const tokenInput = document.getElementById('admin-token-input');
                    if (tokenInput) tokenInput.value = getAdminToken();

                    // System health polling
                    fetchHealth();
                    setInterval(fetchHealth, 5000);

                    // Drag & Drop
                    const dropZone = document.getElementById('drop-zone');
                    const fileInput = document.getElementById('file-input');

                    dropZone.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', handleFiles);

                    // Prevent default drag behaviors on the window to avoid browser opening file
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        window.addEventListener(eventName, preventDefaults, false);
                        dropZone.addEventListener(eventName, preventDefaults, false);
                    });

                    function preventDefaults(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    // Highlight drop zone
                    ['dragenter', 'dragover'].forEach(eventName => {
                        dropZone.addEventListener(eventName, highlight, false);
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, unhighlight, false);
                    });

                    function highlight(e) {
                        dropZone.classList.add('border-white', 'bg-[#222]');
                    }

                    function unhighlight(e) {
                        dropZone.classList.remove('border-white', 'bg-[#222]');
                    }

                    dropZone.addEventListener('drop', handleDrop, false);

                    function handleDrop(e) {
                        const dt = e.dataTransfer;
                        const files = dt.files;
                        handleFiles({ files: files });
                    }
                });

                // --- UTILS ---
                function log(message) {
                    const miniLog = document.getElementById('mini-log');
                    if (!miniLog) return;
                    const entry = document.createElement('div');
                    entry.className = 'text-[#888]';
                    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                    miniLog.appendChild(entry);
                    miniLog.scrollTop = miniLog.scrollHeight;
                }

                function saveAdminToken() {
                    const input = document.getElementById('admin-token-input');
                    const token = (input?.value || '').trim();
                    setAdminToken(token);
                    log(token ? 'Admin token saved' : 'Admin token cleared');
                    showSaved();
                }

                function clearAdminToken() {
                    const input = document.getElementById('admin-token-input');
                    if (input) input.value = '';
                    setAdminToken('');
                    log('Admin token cleared');
                    showSaved();
                }

                function switchTab(tab) {
                    currentTab = tab;

                    // Update Buttons
                    const btnActive = document.getElementById('tab-active');
                    const btnCompleted = document.getElementById('tab-completed');

                    if (tab === 'active') {
                        btnActive.className = "flex-1 py-3 text-[11px] font-bold uppercase tracking-wider text-white border-b-2 border-blue-500 bg-[#222]";
                        btnCompleted.className = "flex-1 py-3 text-[11px] font-bold uppercase tracking-wider text-[#666] hover:text-[#aaa] border-b-2 border-transparent";
                    } else {
                        btnActive.className = "flex-1 py-3 text-[11px] font-bold uppercase tracking-wider text-[#666] hover:text-[#aaa] border-b-2 border-transparent";
                        btnCompleted.className = "flex-1 py-3 text-[11px] font-bold uppercase tracking-wider text-white border-b-2 border-blue-500 bg-[#222]";
                    }

                    renderList();
                }

                async function handleFiles(filesOrEvent) {
                    const files = filesOrEvent.files || filesOrEvent.target.files;
                    if (!files.length) return;

                    const formData = new FormData();
                    formData.append('file', files[0]);

                    try {
                        log("Uploading " + files[0].name + "...");
                        const res = await fetch('/api/upload', {
                            method: 'POST',
                            headers: { ...adminHeaders() },
                            body: formData
                        });
                        const data = await res.json();
                        if (data.success) {
                            log("Upload Complete: " + files[0].name);
                            fetchJobs();
                        } else {
                            log("Upload Failed: " + data.error);
                        }
                    } catch (err) {
                        log("Upload Error: " + err);
                    }
                }


                async function fetchJobs() {
                    try {
                        const res = await fetch('/api/jobs');
                        jobsData = await res.json();
                        renderList();
                        if (selectedStem) updateInspector();
                    } catch (err) {
                        console.error(err);
                    }
                }

                function formatAge(seconds) {
                    if (seconds === null || seconds === undefined) return '‚Äî';
                    if (seconds < 60) return `${seconds.toFixed(0)}s`;
                    const mins = Math.floor(seconds / 60);
                    const rem = Math.floor(seconds % 60);
                    return `${mins}m ${rem}s`;
                }

                async function fetchHealth() {
                    try {
                        const res = await fetch('/api/health');
                        const h = await res.json();

                        const mgrEl = document.getElementById('sys-manager');
                        const ssdEl = document.getElementById('sys-ssd');
                        const diskEl = document.getElementById('sys-disk');

                        const mgrAge = h?.heartbeats?.omega_manager_age_seconds;
                        if (mgrEl) {
                            const online = typeof mgrAge === 'number' && mgrAge < 10;
                            mgrEl.textContent = online ? `ONLINE (${formatAge(mgrAge)})` : `OFFLINE (${formatAge(mgrAge)})`;
                            mgrEl.className = `font-mono ${online ? 'text-emerald-400' : 'text-red-400'}`;
                        }

                        if (ssdEl) {
                            const ready = !!h?.storage_ready;
                            ssdEl.textContent = ready ? 'READY' : 'NOT READY';
                            ssdEl.className = `font-mono ${ready ? 'text-emerald-400' : 'text-red-400'}`;
                        }

                        if (diskEl) {
                            const free = h?.disk_free_gb;
                            if (typeof free === 'number') {
                                diskEl.textContent = `${free.toFixed(1)} GB`;
                                diskEl.className = `font-mono ${free < 20 ? 'text-amber-400' : 'text-[#aaa]'}`;
                            } else {
                                diskEl.textContent = '‚Äî';
                                diskEl.className = 'font-mono text-[#666]';
                            }
                        }
                    } catch (err) {
                        const mgrEl = document.getElementById('sys-manager');
                        const ssdEl = document.getElementById('sys-ssd');
                        const diskEl = document.getElementById('sys-disk');
                        if (mgrEl) { mgrEl.textContent = 'ERROR'; mgrEl.className = 'font-mono text-red-400'; }
                        if (ssdEl) { ssdEl.textContent = 'ERROR'; ssdEl.className = 'font-mono text-red-400'; }
                        if (diskEl) { diskEl.textContent = 'ERROR'; diskEl.className = 'font-mono text-red-400'; }
                    }
                }

                function calculateElapsed(job) {
                    if (!job.meta || !job.meta.ingest_time) return "--:--";
                    const start = new Date(job.meta.ingest_time);

                    // FIX: Use burn_end_time if available to stop the timer
                    let end = new Date();
                    if (job.meta.burn_end_time) {
                        end = new Date(job.meta.burn_end_time);
                    } else if (job.meta.burn_completed_at) {
                        end = new Date(job.meta.burn_completed_at);
                    } else if (job.stage === 'COMPLETED' || job.stage === 'PUBLISHED') {
                        // Fallback if burn_end_time is missing but job is done
                        end = new Date(job.updated_at);
                    }

                    const diffMs = end - start;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffSecs = Math.floor((diffMs % 60000) / 1000);
                    return `${diffMins}m ${diffSecs}s`;
                }

                function renderList() {
                    const tbody = document.getElementById('job-list');

                    // Filter Jobs
                    const filteredJobs = jobsData.filter(job => {
                        const statusLower = job.status.toLowerCase();
                        const stageUpper = (job.stage || '').toUpperCase();
                        // Robust Completion Check: Completed OR Error OR Stalled
                        const isDone = stageUpper === 'COMPLETED' ||
                            stageUpper === 'DEAD' ||
                            job.progress >= 100 ||
                            statusLower.includes('done') ||
                            statusLower.includes('completed') ||
                            statusLower.includes('dead') ||
                            statusLower.includes('halted') ||
                            statusLower.includes('error') ||
                            statusLower.includes('failed') ||
                            statusLower.includes('stalled');

                        if (currentTab === 'active') {
                            return !isDone;
                        } else {
                            return isDone;
                        }
                    });

                    // Sort: Active -> Newest First? Or Oldest First (FIFO)?
                    // Usually Queue is FIFO (Oldest First).
                    // Completed is Newest First.
                    filteredJobs.sort((a, b) => {
                        const dateA = new Date(a.updated_at || 0);
                        const dateB = new Date(b.updated_at || 0);
                        return currentTab === 'active' ? dateA - dateB : dateB - dateA;
                    });

                    tbody.innerHTML = filteredJobs.map(job => {
                        const isSelected = job.file_stem === selectedStem;
                        const statusLower = (job.status || '').toLowerCase();
                        let statusIcon = '‚ö™Ô∏è';
                        if (statusLower.includes('dead') || statusLower.includes('halted') || statusLower.includes('error') || statusLower.includes('failed')) statusIcon = 'üî¥';
                        else if (statusLower.includes('done') || statusLower.includes('completed')) statusIcon = 'üü¢';
                        else if (statusLower.includes('waiting')) statusIcon = 'üü°';
                        else if ((job.stage || '').toUpperCase() !== 'INGEST') statusIcon = 'üîµ';

                        const elapsed = calculateElapsed(job);

                        return `
                <tr onclick="selectJob('${job.file_stem}')" class="cursor-pointer hover:bg-[#222] transition-colors border-b border-[#222] group ${isSelected ? 'bg-[#1a1a1a]' : ''}">
                    <td class="p-4 text-xs">${statusIcon}</td>
                    <td class="p-4 font-medium text-white group-hover:text-blue-400 transition-colors">${job.file_stem}</td>
                    <td class="p-4 text-[#888] text-xs">${job.status}</td>
                    <td class="p-4 text-[#666] text-xs font-mono">${elapsed}</td>
                    <td class="p-4">
                        <div class="w-full h-1 bg-[#333] rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 transition-all duration-500" style="width: ${job.progress}%"></div>
                        </div>
                    </td>
                </tr>
            `;
                    }).join('');
                }

                let selectedJobId = null;

                function selectJob(jobId) {
                    console.log(`Selected job: ${jobId}`);
                    selectedJobId = jobId;
                    selectedStem = jobId; // Sync selectedStem

                    // Remove selected-row from previous selection
                    document.querySelectorAll('#job-list tr').forEach(row => {
                        row.classList.remove('selected-row');
                    });

                    // Add selected-row to current selection
                    const selectedRow = document.querySelector(`#job-list tr[onclick*="${jobId}"]`);
                    if (selectedRow) {
                        selectedRow.classList.add('selected-row');
                    }

                    // Show inspector content and hide empty state
                    document.getElementById('inspector-empty').classList.add('hidden');
                    document.getElementById('inspector-content').classList.remove('hidden');

                    updateInspector();
                }

                function formatDuration(seconds) {
                    if (seconds === null || seconds === undefined || isNaN(seconds)) return "--";
                    const total = Math.max(0, Math.floor(seconds));
                    const h = Math.floor(total / 3600);
                    const m = Math.floor((total % 3600) / 60);
                    const s = total % 60;
                    if (h > 0) return `${h}h ${m}m ${s}s`;
                    if (m > 0) return `${m}m ${s}s`;
                    return `${s}s`;
                }

                function formatTime(iso) {
                    if (!iso) return "--";
                    const d = new Date(iso);
                    if (isNaN(d.getTime())) return "--";
                    return d.toLocaleTimeString();
                }

                function parseIso(iso) {
                    if (!iso) return null;
                    const d = new Date(iso);
                    if (isNaN(d.getTime())) return null;
                    return d;
                }

                function renderTimeline(entries, containerId, emptyText) {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    if (!Array.isArray(entries) || entries.length === 0) {
                        container.innerHTML = `<div class="text-xs text-[#555]">${emptyText}</div>`;
                        return;
                    }
                    const now = new Date();
                    container.innerHTML = entries.map(entry => {
                    const stage = (entry.stage || "UNKNOWN").toString().replace(/^CLOUD_/, "");
                        const started = parseIso(entry.started_at);
                        const ended = parseIso(entry.ended_at);
                        const duration = started ? ((ended || now) - started) / 1000 : null;
                        const running = !ended;
                        const label = running ? "‚ñ∂" : "‚Ä¢";
                        const rowClass = running ? "text-white" : "text-[#aaa]";
                        return `
                            <div class="flex items-center justify-between gap-2 ${rowClass}">
                                <span>${label} ${stage}</span>
                                <span class="text-[#666]">${formatDuration(duration)}</span>
                            </div>
                        `;
                    }).join('');
                }

                function renderStatusTimeline(entries, containerId, maxItems = 6) {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    if (!Array.isArray(entries) || entries.length === 0) {
                        container.innerHTML = `<div class="text-xs text-[#555]">No status history yet.</div>`;
                        return;
                    }
                    const slice = entries.slice(-maxItems).reverse();
                    container.innerHTML = slice.map(entry => {
                        const status = (entry.status || "").toString();
                        const time = formatTime(entry.at);
                        return `
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-[#888] truncate">${status}</span>
                                <span class="text-[#555]">${time}</span>
                            </div>
                        `;
                    }).join('');
                }

                function updateMonitoring(job, meta) {
                    const stageTimeline = Array.isArray(meta?.stage_timeline) ? meta.stage_timeline : [];
                    const cloudTimeline = Array.isArray(meta?.cloud_stage_timeline) ? meta.cloud_stage_timeline : [];
                    const statusTimeline = Array.isArray(meta?.status_timeline) ? meta.status_timeline : [];
                    const cloudProgress = meta?.cloud_progress || null;

                    renderTimeline(stageTimeline, "monitor-stage-list", "No pipeline data yet.");
                    renderTimeline(cloudTimeline, "monitor-cloud-list", "No cloud activity yet.");
                    renderStatusTimeline(statusTimeline, "monitor-status-list");

                    const cloudSummaryEl = document.getElementById("monitor-cloud-summary");
                    if (cloudSummaryEl) {
                        if (cloudProgress && (cloudProgress.status || cloudProgress.progress !== null)) {
                            const prog = cloudProgress.progress !== null && cloudProgress.progress !== undefined
                                ? `${Math.round(cloudProgress.progress)}%`
                                : "--";
                            const status = cloudProgress.status || "Cloud running";
                            const updated = formatTime(cloudProgress.updated_at);
                            cloudSummaryEl.innerText = `${status} ‚Ä¢ ${prog} ‚Ä¢ Updated ${updated}`;
                        } else {
                            cloudSummaryEl.innerText = "No cloud progress yet.";
                        }
                    }

                    const totalEl = document.getElementById("monitor-total");
                    if (totalEl) {
                        let total = null;
                        if (stageTimeline.length > 0) {
                            const first = parseIso(stageTimeline[0]?.started_at);
                            const last = parseIso(stageTimeline[stageTimeline.length - 1]?.ended_at) || new Date();
                            if (first) total = (last - first) / 1000;
                        }
                        const updated = formatTime(job.updated_at);
                        totalEl.innerText = `${formatDuration(total)} ‚Ä¢ Updated ${updated}`;
                    }
                }

                function updateInspector() {
                    const job = jobsData.find(j => j.file_stem === selectedJobId);
                    if (!job) return;

                    const stageUpper = (job.stage || '').toUpperCase();
                    const statusText = job.status || '';
                    const statusLower = statusText.toLowerCase();
                    const meta = job.meta || {};

                    document.getElementById('insp-title').innerText = job.file_stem;
                    document.getElementById('insp-id').innerText = `Stage: ${stageUpper || '‚Äî'} ‚Ä¢ ${statusText}`;

                    // Status Badge
                    document.getElementById('insp-status-text').innerText = statusText;
                    const statusDot = document.getElementById('insp-status-dot');
                    const halted = !!meta.halted || stageUpper === 'DEAD';
                    const done = stageUpper === 'COMPLETED' || statusLower.includes('done') || statusLower.includes('completed');
                    const waitingApproval = statusLower.includes('waiting for burn approval') || statusLower.includes('pending approval');
                    if (halted) statusDot.className = "w-2 h-2 rounded-full bg-red-500";
                    else if (done) statusDot.className = "w-2 h-2 rounded-full bg-emerald-500";
                    else if (waitingApproval) statusDot.className = "w-2 h-2 rounded-full bg-amber-500 animate-pulse";
                    else statusDot.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse";

                    // Stepper Logic
                    const progress = job.progress;
                    updateStep('ingest', progress >= 30, progress < 30 && progress > 0);
                    updateStep('translate', progress >= 70, progress < 70 && progress >= 30);
                    updateStep('burn', progress >= 100, progress < 100 && progress >= 70);

                    // Update Inputs (Only if not focused to avoid jitter)
                    if (document.activeElement.id !== 'insp-lang') document.getElementById('insp-lang').value = job.target_language || 'is';
                    if (document.activeElement.id !== 'insp-profile') document.getElementById('insp-profile').value = job.program_profile || 'standard';
                    if (document.activeElement.id !== 'insp-style') document.getElementById('insp-style').value = job.subtitle_style || 'Classic';

                    // Mode Buttons
                    const mode = meta?.mode || 'AUTO';
                    document.getElementById('btn-mode-auto').className = `flex-1 py-2 text-[11px] font-medium rounded-md transition-all ${mode === 'AUTO' ? 'bg-white text-black shadow-sm' : 'text-[#666] hover:text-white hover:bg-[#333]'}`;
                    document.getElementById('btn-mode-review').className = `flex-1 py-2 text-[11px] font-medium rounded-md transition-all ${mode === 'REVIEW' ? 'bg-white text-black shadow-sm' : 'text-[#666] hover:text-white hover:bg-[#333]'}`;

                    // Approve Button
                    const btnApprove = document.getElementById('btn-approve');
                    if (waitingApproval) {
                        btnApprove.classList.remove('hidden');
                        btnApprove.classList.add('animate-pulse');
                    } else {
                        btnApprove.classList.add('hidden');
                        btnApprove.classList.remove('animate-pulse');
                    }

                    // Locking Logic
                    const isLocked = ['INGEST', 'TRANSLATING', 'REVIEWING', 'FINALIZING', 'BURNING'].includes(stageUpper);
                    updateInspectorState(isLocked);

                    // Output
                    const outputDiv = document.getElementById('output-section');
                    const outputPathEl = document.getElementById('output-path');
                    const downloadBtn = document.getElementById('btn-download-output');
                    const outputPath = meta.final_output || '';
                    if (outputPath || stageUpper === 'COMPLETED') {
                        outputDiv.classList.remove('hidden');
                        outputPathEl.innerText = outputPath || '(not recorded yet)';
                        const token = getAdminToken();
                        const qp = token ? `?admin_token=${encodeURIComponent(token)}` : '';
                        downloadBtn.href = `/api/output/${encodeURIComponent(job.file_stem)}${qp}`;
                    } else {
                        outputDiv.classList.add('hidden');
                    }

                    // Error / Halt box
                    const errorBox = document.getElementById('error-box');
                    const errorTextEl = document.getElementById('error-text');
                    const haltBadge = document.getElementById('halt-badge');
                    const unhaltBtn = document.getElementById('btn-unhalt');

                    const lastError = meta.last_error || (halted ? statusText : '');
                    if (lastError) {
                        errorBox.classList.remove('hidden');
                        errorTextEl.innerText = lastError;
                    } else {
                        errorBox.classList.add('hidden');
                    }

                    if (halted) {
                        haltBadge.classList.remove('hidden');
                        unhaltBtn.classList.remove('hidden');
                    } else {
                        haltBadge.classList.add('hidden');
                        unhaltBtn.classList.add('hidden');
                    }

                    // Quality Report Logic
                    const reportDiv = document.getElementById('quality-report');
                    if (job.editor_report) {
                        try {
                            const report = JSON.parse(job.editor_report);
                            reportDiv.classList.remove('hidden');

                            // Rating Color
                            const rating = report.rating || 0;
                            const ratingEl = document.getElementById('qr-rating');
                            ratingEl.innerText = rating + "/10";
                            if (rating >= 9) ratingEl.className = "px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold";
                            else if (rating >= 7) ratingEl.className = "px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 text-xs font-bold";
                            else ratingEl.className = "px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs font-bold";

                            document.getElementById('qr-tier').innerText = report.quality_tier || "Unknown";
                            document.getElementById('qr-summary').innerText = report.summary || "No summary available.";

                            // Issues
                            const issuesContainer = document.getElementById('qr-issues-container');
                            const issuesList = document.getElementById('qr-issues');
                            if (report.major_issues && report.major_issues.length > 0) {
                                issuesContainer.classList.remove('hidden');
                                issuesList.innerHTML = report.major_issues.map(i => `<li>${i}</li>`).join('');
                            } else {
                                issuesContainer.classList.add('hidden');
                            }

                            // Suggestions
                            const suggContainer = document.getElementById('qr-suggestions-container');
                            if (report.suggestions) {
                                suggContainer.classList.remove('hidden');
                                document.getElementById('qr-suggestions').innerText = report.suggestions;
                            } else {
                                suggContainer.classList.add('hidden');
                            }

                        } catch (e) {
                            console.error("Failed to parse editor report", e);
                            reportDiv.classList.add('hidden');
                        }
                    } else {
                        reportDiv.classList.add('hidden');
                    }

                    // Broadcast QA (Caps)
                    const qaDiv = document.getElementById('broadcast-qa');
                    const qaCaps = meta?.qa_caps || null;
                    const fullCaps = qaCaps?.full_caps || 0;
                    const mostlyCaps = qaCaps?.mostly_caps || 0;
                    const totalCapsBlocks = qaCaps?.total || 0;
                    if (qaCaps && (fullCaps > 0 || mostlyCaps > 0)) {
                        qaDiv.classList.remove('hidden');

                        const badge = document.getElementById('qa-caps-badge');
                        const issues = fullCaps + mostlyCaps;
                        badge.innerText = totalCapsBlocks ? `${issues}/${totalCapsBlocks}` : `${issues}`;
                        if (fullCaps > 0) {
                            badge.className = "px-2 py-1 rounded bg-red-500/20 text-red-300 text-xs font-bold";
                        } else {
                            badge.className = "px-2 py-1 rounded bg-yellow-500/20 text-yellow-300 text-xs font-bold";
                        }

                        const msg = `Caps warning: ${fullCaps} ALL CAPS + ${mostlyCaps} mostly-caps blocks detected. Use Retry Review ‚Üí Retry Finalize ‚Üí Force Burn to regenerate.`;
                        document.getElementById('qa-caps-text').innerText = msg;

                        const samplesContainer = document.getElementById('qa-caps-samples-container');
                        const samplesList = document.getElementById('qa-caps-samples');
                        const samples = qaCaps?.samples || [];
                        if (Array.isArray(samples) && samples.length > 0) {
                            samplesContainer.classList.remove('hidden');
                            samplesList.innerHTML = '';
                            samples.forEach(sample => {
                                const li = document.createElement('li');
                                li.textContent = String(sample);
                                samplesList.appendChild(li);
                            });
                        } else {
                            samplesContainer.classList.add('hidden');
                        }
                    } else {
                        qaDiv.classList.add('hidden');
                    }

                    // Subtitle QA
                    const srtQaDiv = document.getElementById('subtitle-qa');
                    const qaSrt = meta?.qa_srt || null;
                    if (qaSrt) {
                        srtQaDiv.classList.remove('hidden');

                        const cps17 = qaSrt?.high_cps_17 || 0;
                        const cps20 = qaSrt?.high_cps_20 || 0;
                        const shortDur = qaSrt?.short_duration || 0;
                        const longDur = qaSrt?.long_duration || 0;
                        const longLines = qaSrt?.long_lines || 0;
                        const dangling = qaSrt?.dangling || 0;
                        const totalBlocks = qaSrt?.total || 0;

                        document.getElementById('qa-srt-cps17').innerText = cps17;
                        document.getElementById('qa-srt-cps20').innerText = cps20;
                        document.getElementById('qa-srt-short').innerText = shortDur;
                        document.getElementById('qa-srt-long').innerText = longDur;
                        document.getElementById('qa-srt-longlines').innerText = longLines;
                        document.getElementById('qa-srt-dangling').innerText = dangling;

                        const issueCount = cps20 + longDur + shortDur + longLines + dangling;
                        const badge = document.getElementById('qa-srt-badge');
                        badge.innerText = totalBlocks ? `${issueCount}/${totalBlocks}` : `${issueCount}`;
                        if (cps20 > 0 || longDur > 0) {
                            badge.className = "px-2 py-1 rounded bg-red-500/20 text-red-300 text-xs font-bold";
                        } else if (issueCount > 0) {
                            badge.className = "px-2 py-1 rounded bg-yellow-500/20 text-yellow-300 text-xs font-bold";
                        } else {
                            badge.className = "px-2 py-1 rounded bg-emerald-500/20 text-emerald-300 text-xs font-bold";
                        }

                        const maxCps = qaSrt?.max_cps || 0;
                        const maxDur = qaSrt?.max_duration || 0;
                        document.getElementById('qa-srt-note').innerText = `Max CPS: ${maxCps} | Max duration: ${maxDur}s`;
                    } else {
                        srtQaDiv.classList.add('hidden');
                    }

                    // Monitoring
                    updateMonitoring(job, meta);
                }

                function updateStep(id, isComplete, isActive) {
                    const dot = document.getElementById(`step-${id}-dot`);
                    const inner = document.getElementById(`step-${id}-inner`);
                    const text = document.getElementById(`step-${id}-text`);

                    if (isComplete) {
                        dot.className = "absolute -left-[13px] w-6 h-6 rounded-full bg-emerald-500/20 border border-emerald-500 flex items-center justify-center z-10";
                        inner.className = "w-2 h-2 rounded-full bg-emerald-500";
                        text.className = "text-xs text-white font-medium ml-6";
                    } else if (isActive) {
                        dot.className = "absolute -left-[13px] w-6 h-6 rounded-full bg-blue-500/20 border border-blue-500 flex items-center justify-center z-10 animate-pulse";
                        inner.className = "w-2 h-2 rounded-full bg-blue-500";
                        text.className = "text-xs text-white font-medium ml-6";
                    } else {
                        dot.className = "absolute -left-[13px] w-6 h-6 rounded-full bg-[#1a1a1a] border border-[#333] flex items-center justify-center z-10";
                        inner.className = "w-1.5 h-1.5 rounded-full bg-[#444]";
                        text.className = "text-xs text-[#666] ml-6";
                    }
                }

                async function runJobAction(action, extra = {}, requireJob = true) {
                    if (requireJob && !selectedJobId) return null;

                    const payload = { action, ...extra };
                    if (requireJob) payload.file_stem = selectedJobId;

                    try {
                        const data = await postJson('/api/action', payload);
                        if (data?.success) log(data.message || `${action}: OK`);
                        else log(`Error: ${data?.error || data?.message || 'Unknown error'}`);
                        fetchJobs();
                        return data;
                    } catch (err) {
                        log(`Network Error: ${err}`);
                        return null;
                    }
                }

                async function updateJobSetting(key, value) {
                    const map = {
                        target_language: ['set_language', 'target_language'],
                        program_profile: ['set_profile', 'program_profile'],
                        subtitle_style: ['set_style', 'subtitle_style'],
                    };
                    const entry = map[key];
                    if (!entry) return;
                    const [action, param] = entry;
                    const data = await runJobAction(action, { [param]: value }, true);
                    if (data?.success) showSaved();
                }

                async function setMode(mode) {
                    const data = await runJobAction('set_mode', { mode }, true);
                    if (data?.success) showSaved();
                }

                async function approveBurn() {
                    await runJobAction('approve_burn', {}, true);
                }

                async function resetReview() {
                    await runJobAction('reset_review', {}, true);
                }

                async function forceBurn() {
                    if (!selectedJobId) return;
                    if (!confirm(`Force burn ${selectedJobId}? This will re-render the burned video.`)) return;
                    await runJobAction('force_burn', {}, true);
                }

                async function retryTranslate() {
                    if (!selectedJobId) return;
                    if (!confirm(`Retry translation for ${selectedJobId}?`)) return;
                    await runJobAction('retry_translate', {}, true);
                }

                async function retryReview() {
                    if (!selectedJobId) return;
                    if (!confirm(`Retry AI review for ${selectedJobId}?`)) return;
                    await runJobAction('retry_review', {}, true);
                }

                async function unhaltJob() {
                    if (!selectedJobId) return;
                    if (!confirm(`Unhalt ${selectedJobId} and resume workflow?`)) return;
                    await runJobAction('unhalt_job', {}, true);
                }

                async function restartManager() {
                    if (!confirm('Restart the Omega Manager? It will restart when safe/idle.')) return;
                    await runJobAction('restart_manager', {}, false);
                }

                async function deleteJob() {
                    if (!selectedJobId) return;
                    if (!confirm(`Are you sure you want to delete ${selectedJobId}? This cannot be undone.`)) return;

                    const data = await runJobAction('delete_job', {}, true);
                    if (data?.success) {
                        selectedJobId = null;
                        selectedStem = null;
                        document.getElementById('inspector-content').classList.add('hidden');
                        document.getElementById('inspector-empty').classList.remove('hidden');
                        fetchJobs();
                    }
                }

                function updateInspectorState(locked) {
                    const inspectorContent = document.getElementById('inspector-content');
                    const lockMsg = document.getElementById('lock-msg');
                    const selects = inspectorContent.querySelectorAll('select');
                    const modeAuto = document.getElementById('btn-mode-auto');
                    const modeReview = document.getElementById('btn-mode-review');

                    if (locked) {
                        lockMsg.classList.remove('hidden');
                        selects.forEach(el => el.setAttribute('disabled', 'true'));
                        if (modeAuto) modeAuto.setAttribute('disabled', 'true');
                        if (modeReview) modeReview.setAttribute('disabled', 'true');
                    } else {
                        lockMsg.classList.add('hidden');
                        selects.forEach(el => el.removeAttribute('disabled'));
                        if (modeAuto) modeAuto.removeAttribute('disabled');
                        if (modeReview) modeReview.removeAttribute('disabled');
                    }
                }
            </script>
            <!-- Surgical Tool Modal -->
            <div id="surgical-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col">
                <!-- Header -->
                <div class="h-14 border-b border-[#333] flex items-center justify-between px-6 bg-[#1a1a1a]">
                    <div class="flex items-center gap-4">
                        <h2 class="text-white font-bold tracking-wider">SURGICAL EDITOR ü©∫</h2>
                        <span id="surgical-filename" class="text-[#666] text-xs font-mono"></span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="closeSurgical()"
                            class="text-[#888] hover:text-white text-xs uppercase font-bold tracking-wider px-4 py-2">Cancel</button>
                        <button onclick="saveSurgical()"
                            class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase tracking-wider px-6 py-2 rounded-md shadow-lg shadow-emerald-900/20 transition-all">Save
                            & Finalize</button>
                    </div>
                </div>

                <!-- Editor Area -->
                <div class="flex-1 flex overflow-hidden">
                    <!-- Video Preview -->
                    <div class="w-[400px] bg-black border-r border-[#333] flex flex-col">
                        <div class="aspect-video bg-black relative">
                            <video id="surgical-video" class="w-full h-full object-contain" controls></video>
                            <div id="video-placeholder"
                                class="absolute inset-0 flex items-center justify-center text-[#444] text-xs">
                                No Preview Available
                            </div>
                        </div>
                        <div class="p-4 text-xs text-[#666] font-mono">
                            <p>Click a subtitle to jump to time.</p>
                        </div>
                    </div>

                    <!-- Subtitles -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <div class="max-w-4xl mx-auto">
                            <div id="surgical-editor" class="space-y-1">
                                <!-- Segments injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // ... Existing Scripts ...

                // Surgical Tool Logic
                let currentSegments = [];
                let currentStem = null;

                async function openSurgical() {
                    if (!selectedJobId) return;
                    currentStem = selectedJobId;
                    document.getElementById('surgical-filename').innerText = currentStem;

                    // Show Modal
                    document.getElementById('surgical-modal').classList.remove('hidden');
                    document.getElementById('surgical-editor').innerHTML = '<div class="text-center text-[#666] py-20">Loading segments...</div>';

                    // Load Video
                    const video = document.getElementById('surgical-video');
                    const placeholder = document.getElementById('video-placeholder');
                    const token = getAdminToken();
                    const qp = token ? `?admin_token=${encodeURIComponent(token)}` : '';
                    video.src = `/api/stream/${currentStem}${qp}`;
                    video.onerror = () => {
                        video.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                    };
                    video.onloadeddata = () => {
                        video.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    };

                    try {
                        const res = await fetch(`/api/surgical/segments?stem=${currentStem}`, { headers: { ...adminHeaders() } });
                        const data = await res.json();

                        if (data.error) throw new Error(data.error);

                        currentSegments = data.segments;
                        renderSegments();

                    } catch (e) {
                        alert("Failed to load segments: " + e.message);
                        closeSurgical();
                    }
                }

                function closeSurgical() {
                    document.getElementById('surgical-modal').classList.add('hidden');
                    currentSegments = [];
                    currentStem = null;
                }

                function renderSegments() {
                    const container = document.getElementById('surgical-editor');
                    container.innerHTML = '';

                    currentSegments.forEach((seg, index) => {
                        const row = document.createElement('div');
                        row.className = "flex gap-4 group bg-[#222] hover:bg-[#2a2a2a] border border-[#333] rounded p-3 transition-colors cursor-pointer";
                        row.onclick = (e) => {
                            // Don't seek if clicking textarea or button
                            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON') return;
                            const video = document.getElementById('surgical-video');
                            if (video) {
                                video.currentTime = seg.start;
                                video.play();
                            }
                        };
                        row.innerHTML = `
                    <div class="w-24 text-[10px] font-mono text-[#666] pt-1.5 flex flex-col gap-1">
                        <div>${formatTime(seg.start)}</div>
                        <div>${formatTime(seg.end)}</div>
                        <div class="text-[#444]">#${seg.id}</div>
                    </div>
                    
                    <!-- Source Text -->
                    <div class="flex-1 text-sm text-[#888] italic font-serif leading-relaxed px-4 border-r border-[#333]">
                        ${seg.source_text || '<span class="opacity-30">No source</span>'}
                    </div>

                    <div class="flex-1 pl-4">
                        <textarea 
                            oninput="updateSegment(${index}, this.value)"
                            onfocus="seekVideo(${seg.start})"
                            class="w-full bg-transparent text-white text-sm font-medium outline-none resize-none border-none p-0 leading-relaxed h-auto overflow-hidden"
                            rows="2"
                        >${seg.text}</textarea>
                    </div>
                    <div class="w-8 flex items-start justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="deleteSegment(${index})" class="text-[#666] hover:text-red-400 p-1">
                            ‚úï
                        </button>
                    </div>
                `;
                        container.appendChild(row);

                        // Auto-resize textarea
                        const ta = row.querySelector('textarea');
                        ta.style.height = 'auto';
                        ta.style.height = ta.scrollHeight + 'px';
                    });
                }

                function updateSegment(index, value) {
                    currentSegments[index].text = value;
                }

                function deleteSegment(index) {
                    if (confirm("Delete this segment?")) {
                        currentSegments.splice(index, 1);
                        renderSegments();
                    }
                }

                async function saveSurgical() {
                    const btn = document.querySelector('button[onclick="saveSurgical()"]');
                    const originalText = btn.innerText;
                    btn.innerText = "Finalizing...";
                    btn.disabled = true;

                    try {
                        const res = await fetch('/api/surgical/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...adminHeaders() },
                            body: JSON.stringify({
                                stem: currentStem,
                                segments: currentSegments
                            })
                        });

                        const data = await res.json();
                        if (data.error) throw new Error(data.error);

                        closeSurgical();
                        showSaved(); // Reuse existing toast

                    } catch (e) {
                        alert("Save failed: " + e.message);
                    } finally {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                }

                function formatTime(seconds) {
                    const date = new Date(seconds * 1000);
                    return date.toISOString().substr(11, 8);
                }

                function seekVideo(time) {
                    const video = document.getElementById('surgical-video');
                    if (video) {
                        video.currentTime = time;
                        // Optional: video.play();
                    }
                }
            </script>
</body>

</html>
